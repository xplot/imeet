this["JST"] = this["JST"] || {};

this["JST"]["add-group.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div class="modal addGroup-modal" tabindex="-1" >\n    <div class="modal-dialog">\n        <div class="modal-content">\n            <div class="modal-header">\n            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&amp;times;</button>\n            <h4 class="modal-title" id="myModalLabel">Add New Group</h4>\n            </div>\n            <div class="modal-body">\n                <input type="text" class="form-control new-group-input" />\n            </div>\n            <div class="modal-footer">\n                <button type="button" class="btn btn-default close-dialog" data-dismiss="modal">Close</button>\n                <button type="button" class="btn btn-primary new-group-btn">Create</button>\n        </div>\n    </div>\n  </div>\n</div>';
    }
    return __p;
};

this["JST"]["contact_details.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div class="modal addContact-modal" tabindex="-1" >\n    <div class="modal-dialog">\n        <div class="modal-content">\n            <div class="modal-header">\n            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&amp;times;</button>\n            <h4 class="modal-title" id="myModalLabel">\n                ';
        if (createMode) {
            __p += "\n                    Add New Contact\n              ";
        } else {
            __p += "\n                    Edit\n              ";
        }
        __p += '\n\n            </h4>\n            </div>\n            <div class="modal-body">\n                <div class="row">\n                    <div class="col-md-2">Name: </div>\n                    <div class="col-md-10">\n                        <input type="text" value="' + __e(contact.name) + '" class="form-control contact_input" id="nameInput" placeholder="Jane Doe" data-validation="required">\n                    </div>\n                </div>\n                <div class="row">\n                    <div class="col-md-2">Phone: </div>\n                    <div class="col-md-10">\n                        <input type="text" value="' + __e(contact.phone) + '" class="form-control contact_input" id="phoneInput" placeholder="000 000 0000" data-validation="phone">\n                    </div>\n                </div>\n                <div class="row">\n                    <div class="col-md-2">Email: </div>\n                    <div class="col-md-10">\n                        <input type="text" value="' + __e(contact.email) + '" class="form-control contact_input" id="emailInput" placeholder="john.smith@example.com" data-validation="email">\n                    </div>\n                </div>\n\n            </div>\n            <div class="modal-footer">\n                <button type="button" class="btn btn-default close-dialog" data-dismiss="modal">Close</button>\n                <button type="button" class="btn btn-primary new-contact-btn">\n                    ';
        if (createMode) {
            __p += "\n                            Create\n                      ";
        } else {
            __p += "\n                            Update\n                      ";
        }
        __p += "\n                </button>\n        </div>\n    </div>\n  </div>\n</div>";
    }
    return __p;
};

this["JST"]["contact_item.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div class="contact-row" data-id="' + __e(unique_id) + '" draggable="true">\n    <div class="editable contact-picture" >\n        <i class="fa fa-person fa-2x"></i>\n    </div>\n\n    <div class="contact-row-container">\n        <div class="contact-name" >\n            ' + __e(name) + '\n        </div>\n        <div class="contact-email" >\n            ' + __e(email) + '\n        </div>\n        <div class="contact-phone" >\n            ' + __e(phone) + '\n        </div>\n    </div>\n\n    <a class="update-contact" href="#"><i class="fa-pen fa-1_2x"></i></a>\n\n    <div class="editable contact-actions">\n        <a class="delete-contact" href="#"><i data-id="' + __e(unique_id) + '" class="fa-delete-garbage-streamline fa-1_2x"></i></a>\n    </div>\n</div>';
    }
    return __p;
};

this["JST"]["contact_item_edit.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div class="row no-margin" data-id="' + __e(unique_id) + '">\n    <div class="editable col-md-3 col-xs-8">\n        <input id="edit-name" value="' + __e(name) + '" placeholder="Name...">\n    </div>\n    <div class="desktop tablet col-md-3">\n        <input id="edit-email" value="' + __e(email) + '" placeholder="Email...">\n    </div>\n    <div class="desktop tablet col-md-3">\n        <input id="edit-phone" value="' + __e(phone) + '" placeholder="Phone...">\n    </div>\n    <div class="col-md-3 update-column">\n        <a href="#" class="finish-edit">OK</a>\n    </div>\n</div>';
    }
    return __p;
};

this["JST"]["contact_item_typeahead.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div class="item-container" data-id="' + __e(unique_id) + '">\n    <i class="fa fa-person fa-2x"></i>\n    <b>' + __e(name) + "</b> " + __e(email) + " " + __e(phone) + "\n</div>";
    }
    return __p;
};

this["JST"]["group-item.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        var color = randomColor();
        var inverse = colorInverter(color);
        __p += '\n<div class="panel panel-default ' + __e(panel_class) + '" data-id="' + __e(unique_id) + '" id="panel_' + __e(unique_id) + '">\n    <div class="panel-heading group-drop-area" role="tab" id="heading_' + __e(unique_id) + '" data-id="' + __e(unique_id) + '">\n        <div class="panel-title group-drop-area" data-id="' + __e(unique_id) + '">\n            <a class="collapsed group-drop-area" data-toggle="collapse" data-parent="#groups_accordion" href="#collapse_' + __e(unique_id) + '"\n               aria-expanded="false" aria-controls="collapse_' + __e(unique_id) + '" data-id="' + __e(unique_id) + '">\n                <div data-id="' + __e(unique_id) + '" class="group-drop-area">\n                    ' + __e(cut(name)) + '<i style="float: right" class="fa fa-angle-down fa-1_5x"></i>\n                </div>\n            </a>\n      </div>\n    </div>\n    <div id="collapse_' + __e(unique_id) + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne" >\n        <div class="panel-body group-box group-drop-area" data-id="' + __e(unique_id) + '" id="groupbox_' + __e(unique_id) + '">\n            Drop Here!!! <br/>\n            ';
        _.each(contacts, function(contact) {
            __p += '\n\n                <div class="col-md-5 group-contact">\n                    ' + __e(cut(contact.name, 8)) + "\n                </div>\n            ";
        });
        __p += "\n        </div>\n    </div>\n</div>\n\n";
    }
    return __p;
};

this["JST"]["group_item_typeahead.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div class="item-container" data-id="' + __e(unique_id) + '">\n    <i class="fa fa-organization fa-2x"></i>\n    <b>' + __e(name) + "</b>\n</div>";
    }
    return __p;
};

this["JST"]["invite.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div class="invite-view">\n    <div class="row">\n        <div id="invite-header"></div>\n    </div>\n    <div class="row">\n        <div id="invite-details" class="invite-subheader-banner"></div>\n    </div>\n\n    <div class="row invite-body no-margin">\n        <div class="small-margin-top"></div>\n        <div class="col-md-1"/>\n        <div class="col-md-4 attendees">\n            <div id="invite-attendees">\n                <!--using invite_attendees.html subview-->\n            </div>\n        </div>\n        <div class="col-md-1"/>\n        <div class="col-md-5 hangout">\n            <div class="row small-margin-top desktop desktop-description">\n                <div class="col-md-12">\n                    <h4>Message from the host</h4>\n                    <div class="invite-description"/>\n                </div>\n            </div>\n\n            <div id="invite-comments"></div>\n\n        </div>\n        <div class="col-md-1"/>\n    </div>\n</div>\n\n\n\n';
    }
    return __p;
};

this["JST"]["invite_admin.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div class="invite-view">\n    <div class="row">\n        <div id="invite-header"></div>\n    </div>\n    <div class="row">\n        <div id="invite-details" class="invite-subheader-banner"></div>\n    </div>\n\n    <div class="row invite-body no-margin">\n        <div class="small-margin-top"></div>\n        <div class="col-md-1"/>\n        <div class="col-md-4 attendees">\n            <div class="notify-all">\n                Want to let people know? <div class=\'notify-all-btn btn btn btn-success\'>Notify All</div>\n            </div>\n\n            <div id="invite-new-attendee"></div>\n\n            <div id="invite-attendees">\n                <!--using invite_attendees.html subview-->\n            </div>\n        </div>\n        <div class="col-md-1"/>\n        <div class="col-md-5 hangout">\n            <div class="row small-margin-top desktop desktop-description">\n                <div class="col-md-12">\n                    <h4>Message from the host</h4>\n                    <div id="invite-description"/>\n                </div>\n            </div>\n\n            <div id="invite-comments"></div>\n\n        </div>\n        <div class="col-md-1"/>\n    </div>\n</div>\n\n\n\n\n';
    }
    return __p;
};

this["JST"]["invite_attendee.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div class="details">\n    ';
        if (status == "organizer") {
            __p += "\n        <b><i>Host</i></b>\n    ";
        }
        __p += "\n    <b>" + __e(name) + "</b> " + __e(email) + " " + __e(phone) + "\n</div>";
    }
    return __p;
};

this["JST"]["invite_attendee_create.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div class="row rsvp no-margin">\n    <div class="panel panel-default no-border no-margin">\n      <div class="panel-heading no-padding">Invite People</div>\n      <div class="panel-body  micro-margin-top">\n          <div>\n              <div class="col-md-10 col-xs-12 no-padding">\n                  <input type="text" class="contact-input form-control"\n                    ';
        if (features.indexOf("voice") != -1) {
            __p += "\n                    data-validation='required,email|phone' placeholder='Name, Phone Number, Email'\n                    ";
        } else {
            __p += "\n                    data-validation='required,email' placeholder='Email Address'\n                    ";
        }
        __p += '>\n              </div>\n              <div class="col-md-2 col-xs-12 no-padding">\n                  <button type="button" class="btn new-contact-button">+</button>\n              </div>\n          </div>\n      </div>\n    </div>\n</div>';
    }
    return __p;
};

this["JST"]["invite_attendees.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div class="row rsvp small-margin-top">\n      ';
        if (attendee != null && attendee.status != "deleted" && attendee.status != "organizer") {
            __p += '\n        <div class="panel panel-default">\n          <div class="panel-heading">\n              ';
            if (attendee.status == "no_response") {
                __p += "\n                    Are you coming?\n              ";
            } else if (attendee.status == "no") {
                __p += "\n                    Sad you can't attend :(\n              ";
            } else if (attendee.status == "yes") {
                __p += "\n                    Glad you're coming :)\n              ";
            }
            __p += '\n          </div>\n\n          <div class="panel-body acknowledge-body">\n            <div class="col-md-6 yes-button">\n                <button type="button" class="btn form-control btn-success invite-attendees-acknowledge-yes response-' + __e(attendee.status) + '">YES</button>\n            </div>\n            <div class="col-md-6 no-button">\n                <button type="button" class="btn form-control btn-danger invite-attendees-acknowledge-no response-' + __e(attendee.status) + '">NO</button>\n            </div>\n          </div>\n        </div>\n      ';
        } else if (attendee != null && attendee.status == "deleted") {
            __p += '\n        <div class="panel panel-default">\n            <div class="panel-heading"></div>\n              <div class="panel-body">\n                <b>The organizer removed you from this event</b>\n            </div>\n        </div>\n      ';
        } else if (attendee != null && attendee.status == "organizer") {
            __p += "\n        <!-- Potentially also add people here -->\n      ";
        } else {
            __p += "\n\n      ";
        }
        __p += '\n\n</div>\n\n<div class="row rsvp no-margin">\n    <div class="panel panel-default no-border">\n      <div class="panel-heading yes">Who is coming?</div>\n      <div class="panel-body">\n        ';
        _.each(confirmed, function(item) {
            __p += "\n            " + ((__t = partial("invite_attendee.html", item)) == null ? "" : __t) + "\n        ";
        });
        __p += '\n      </div>\n   </div>\n\n    <div class="panel panel-default no-border">\n      <div class="panel-heading no">Who is not coming?</div>\n      <div class="panel-body">\n        ';
        _.each(negated, function(item) {
            __p += "\n            " + ((__t = partial("invite_attendee.html", item)) == null ? "" : __t) + "\n        ";
        });
        __p += '\n      </div>\n   </div>\n\n    <div class="panel panel-default no-border">\n      <div class="panel-heading">\n          Who is invited?\n\n      </div>\n\n      <div class="panel-body no-response-table">\n        ';
        _.each(no_response, function(item) {
            __p += "\n            " + ((__t = partial("invite_attendee.html", item)) == null ? "" : __t) + "\n        ";
        });
        __p += "\n      </div>\n   </div>\n\n\n</div>\n\n";
    }
    return __p;
};

this["JST"]["invite_comment.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div class="row ">\n    <span class="comment-date pull-right">' + __e(on) + '</span>\n    <div class="col-md-12 invite-comment-row">\n        <span class="comment-author">\n            ';
        if (author == null) {
            __p += "\n                Anonymous\n            ";
        } else {
            __p += "\n                " + __e(author) + "\n            ";
        }
        __p += "\n            </span> : " + __e(comment) + "\n    </div>\n</div>";
    }
    return __p;
};

this["JST"]["invite_comments.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div class="row small-margin-top">\n    <div class="col-md-12 no-margin">\n        <h4>Comments</h4>\n    </div>\n</div>\n\n<div class="row ">\n    <div class="col-md-12 no-margin">\n        <textarea class="invite-comment-input" placeholder="Add comment"></textarea>\n    </div>\n</div>\n\n<div class="row">\n    <div class="col-md-6 no-margin">\n        <button type="button" class="btn form-control btn-success add-comment">Add Comment</button>\n    </div>\n</div>\n\n<div class="row invite-comments">\n    <div class="col-md-12 invite-comments-container">\n        ';
        _.each(comments, function(comment) {
            __p += "\n            " + ((__t = partial("invite_comment.html", comment)) == null ? "" : __t) + "\n        ";
        });
        __p += "\n    </div>\n</div>\n\n";
    }
    return __p;
};

this["JST"]["invite_create.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div id="invite-create">\n    <div class="row no-margin event-title-row">\n        <div class="no-padding col-xs-12 col-md-8 col-md-offset-2 text-center">\n            <h1>Create iMeet <i class="fa fa-paper-plane fa-1x"></i></h1>\n        </div>\n    </div>\n\n    ';
        if (currentUser == null) {
            __p += '\n        <div class="desktop row no-margin">\n            <div class="no-padding col-xs-12 col-md-8 col-md-offset-2 text-center">\n                <label class="small-text">\n                Note: For sms/calls to work, you have to be a registered\n                <br/>\n                Note2: Sms/calls will be free only during the beta phase. After that a subscription base fee will be offered\n                </label>\n            </div>\n        </div>\n    ';
        }
        __p += '\n\n    <div class="row no-margin event-title-input-row">\n        <div class="no-padding col-xs-12 col-md-8 col-md-offset-2">\n            <input type="text" class="form-control event-name-input valid-before-submit" placeholder="Event Title" autofocus data-validation="required" value="' + __e(title) + '" >\n        </div>\n    </div>\n\n    <div class="row no-margin location-input-row">\n        <div class="no-padding col-xs-12 col-md-8 col-md-offset-2">\n              <input type="text" class="form-control event-location-input" placeholder="Location...."  >\n        </div>\n    </div>\n\n    <div class="mobile tablet row no-margin from-event-date-row">\n        <div class="no-padding col-xs-12 col-md-2 text-center label-text text-center">\n            <h1>From</h1>\n        </div>\n    </div>\n\n    <div class="row no-margin event-date-row">\n        <div class="no-padding date-group col-xs-12 col-md-3 col-md-offset-2" id="start-date-group">\n            <input readonly="true" required type="text" class="date event-start-date valid-before-submit" placeholder="01/01/2000" data-validation="required,date"  value="' + __e(start_date) + '">\n            <input readonly="true" required type="int" class="time event-start-time  valid-before-submit" placeholder="00:00 AM" data-validation="required"  value="' + __e(start_time) + '">\n        </div>\n\n        <div class="no-padding col-xs-12 col-md-2 text-center to-event-date-row">\n            <h1>To</h1>\n        </div>\n\n        <div class="no-padding date-group col-xs-12  col-md-3 end-event-date-input-row" id="end-date-group">\n            <input readonly="true" required type="text" class="date event-end-date" placeholder="01/01/2000" value="' + __e(end_date) + '">\n            <input readonly="true" required type="text" class="time event-end-time" placeholder="00:00 AM"  value="' + __e(end_time) + '">\n        </div>\n\n    </div>\n\n    <div class="row desktop no-margin description-row">\n        <div class="no-padding col-xs-12 col-md-8 col-md-offset-2 ">\n          <textarea class="form-control event-description-input" rows="6"></textarea>\n        </div>\n    </div>\n\n\n    <!--<div class="no-margin">-->\n        <!--<div class="no-padding col-xs-12  col-md-3 col-md-offset-2">-->\n            <!--<div class=" facebook_share pull-right" style="display: inline-block">-->\n                <!--<div>Share on Facebook</div>-->\n                <!--<div><input type="checkbox"-->\n                   <!--data-toggle="toggle"-->\n                   <!--id="bt_toggle"-->\n                   <!--class="share_to_facebook"-->\n                   <!--data-style="android"-->\n                   <!--data-on=" " data-off=" "-->\n                   <!--data-onstyle="info"-->\n                   <!--data-onstyle="success" data-offstyle="danger" />-->\n                <!--</div>-->\n            <!--</div>-->\n        <!--</div>-->\n    <!--</div>-->\n\n    <div class="row no-margin button-row">\n        <div class="no-padding text-center col-xs-12  col-md-8 col-md-offset-2">\n            <button type="button" class="btn form-control btn-success send">Create</button>\n        </div>\n    </div>\n</div>\n';
    }
    return __p;
};

this["JST"]["invite_details.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div id="invite-details-container"\n    ';
        if (is_edit) {
            __p += '\n        class="edit"\n     ';
        } else {
            __p += '\n        class=""\n     ';
        }
        __p += "\n>\n";
        if (is_admin) {
            __p += "\n    <div class=\"row\">\n        <div class='col-md-12 col-xs-12 edit_button_container'>\n        ";
            if (!is_edit) {
                __p += '\n            <button class="btn btn-success edit_invite">Edit iMeet</button>\n         ';
            } else {
                __p += '\n            <button class="btn btn-success save_invite">Save</button>\n         ';
            }
            __p += "\n    </div>\n";
        }
        __p += '\n\n\n</div>\n\n<div class="row no-margin">\n    <div class="col-md-2"></div>\n\n    <div class=\'col-md-2 col-xs-12\'>\n        <div class="title">Event Start Time</div>\n        ';
        if (!is_edit) {
            __p += '\n            <div class="details invite-date">' + __e(start_date) + " " + __e(start_time) + "</div>\n        ";
        } else {
            __p += '\n            <div class="date-group" id="start-date-group">\n                <input readonly="true" required type="text" class="date event-start-date valid-before-submit" placeholder="01/01/2000" data-validation="required,date"  value="' + __e(start_date) + '">\n                <input readonly="true" required type="int" class="time event-start-time  valid-before-submit" placeholder="00:00 AM" data-validation="required"  value="' + __e(start_time) + '">\n            </div>\n        ';
        }
        __p += "\n    </div>\n\n    <div class='col-md-2  col-xs-12 '>\n        <div class=\"title\">Event End Time</div>\n        ";
        if (!is_edit) {
            __p += '\n            <div class="details invite-end-date">' + __e(end_date) + " " + __e(end_time) + "</div>\n        ";
        } else {
            __p += '\n            <div class="date-group" id="end-date-group">\n                <input readonly="true" required type="text" class="date event-end-date" placeholder="01/01/2000" data-validation="date"  value="' + __e(end_date) + '">\n                <input readonly="true" required type="int" class="time event-end-time" placeholder="00:00 AM" data-validation="required"  value="' + __e(end_time) + '">\n            </div>\n        ';
        }
        __p += "\n    </div>\n\n     <div class='col-md-4 col-xs-12 invite-location-container'>\n         ";
        if (!is_edit) {
            __p += '\n            <div class="location-image"><i class="fa fa-map-pin-streamline fa-15x"></i></div>\n            <div id="invite-location" class="title">\n                ' + __e(where) + "\n            </div>\n         ";
        } else {
            __p += '\n            <div class="title">Location</div>\n            <div><input type="text" class="form-control event-location-input" placeholder="Location...."  ></div>\n         ';
        }
        __p += "\n     </div>\n</div>\n\n</div>\n\n";
    }
    return __p;
};

this["JST"]["invite_header.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div class="block block1 invite-background"\n     ';
        if (poster_image_id != null) {
            print("style='background-image: url(/image/" + poster_image_id + ")'");
        } else {
            print("style='background-image: url(/img/default_image.jpg)'");
        }
        __p += '\n>\n    <div class="center-block">\n       <div class="invite-title-container">\n       </div>\n       <div class="upload">\n            <form id="upload_image_form" data-id="' + __e(unique_id) + '" method="POST" enctype="multipart/form-data">\n                <input type="file" name="upload_image_file" id="upload_image_file" >\n            </form>\n            <button id="image_select_btn" class="btn btn-success">Change cover</button>\n       </div>\n\n    </div>\n\n</div>\n';
    }
    return __p;
};

this["JST"]["invite_search.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '\n<div id="search-view">\n\n    <div class="row no-margin desktop">\n        <div class="col-sm-10 no-padding">\n            <input id="searchBox" type="text" class="form-control event-name" placeholder="Invite Title" data-validation="required">\n        </div>\n\n        <div class="col-sm-2 no-padding">\n            <button type="button" class="btn btn-success form-control search">Search</button>\n        </div>\n    </div>\n\n    <div class="controls" id="search-result">\n        ';
        if (invites.length == 0) {
            __p += '\n            Your search didn\'t resolved any iMeets. <a href="/new" type="button" class="btn btn-success">Start sending!</a>\n        ';
        }
        __p += "\n\n        ";
        _.each(invites, function(item) {
            __p += '\n\n            <div class="block block1 invite-background" data-id="' + __e(item.unique_id) + '"\n                    ';
            if (item.poster_image_id != null) {
                print("style='background-image: url(/image/" + item.poster_image_id + ")'");
            } else {
                print("style='background-image: url(/img/default_image.jpg)'");
            }
            __p += '\n                >\n                <div class="center-block" data-id="' + __e(item.unique_id) + '">\n                    <h1 class="main-h1" data-id="' + __e(item.unique_id) + '">' + __e(item.title) + '</h1>\n                    <div class="actions">\n                        <div class="row">\n                            <div class="col-xs-6 col-md-6 no-padding">\n                                <button type=\'button\' class=\'btn btn-info form-control btn-duplicate\' data-id="' + __e(item.unique_id) + "\">Duplicate</button>\n                            </div>\n\n                            <div class=\"col-xs-6 col-md-6 no-padding edit-btn\">\n                                <button type='button' class='btn btn-info form-control btn-edit' data-id=\"" + __e(item.unique_id) + '">Edit</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n            </div>\n        ';
        });
        __p += "\n    </div>\n</div>\n\n";
    }
    return __p;
};

this["JST"]["invite_sent.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape, __j = Array.prototype.join;
    function print() {
        __p += __j.call(arguments, "");
    }
    with (obj) {
        __p += '<div class="modal-content">\n    <form id="registerForm">\n        <div class="close-modal" data-action="dismiss">\n            <div class="lr">\n                <div class="rl">\n                </div>\n            </div>\n        </div>\n\n        <div class="container">\n            <div class="row">\n                Invite Link <a href="http://imeet.io/invite/';
        print(invite_id);
        __p += '"><h5 class="text-lowercase">http://imeet.io/invite/';
        print(invite_id);
        __p += '</h5></a>\n            </div>\n            <div class="row small-margin-top"></div>\n            <div class="row">\n               Register\n               <div class="controls">\n                   <div class="col-sm-3"></div>\n                    <div class="col-sm-6">\n                        <div class="col-sm-9">\n                            <input required type="email" class="form-control register-email" placeholder="Enter email..." data-validation="email">\n                        </div>\n                        <div class="col-sm-3">\n                            <button type="button" class="btn btn-success form-control submit-register">Go</button>\n                        </div>\n                    </div>\n                    <div class="col-sm-3"></div>\n                </div>\n           </div>\n        </div>\n    </form>\n</div>\n';
    }
    return __p;
};

this["JST"]["login.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div id="login-page">\n<form id="loginForm" action="/login" method="post">\n\n<div class="login-box">\n    <div class="row no-margin text-center">\n        <div class="no-padding col-md-6 col-xs-6">\n             <a href="/social_login/facebook" class="btn btn-facebook ">Login with Facebook<i class="fa fa-facebook fa-2x"></i></a>\n        </div>\n        <div class="no-padding col-md-6 col-xs-6">\n            <a href="/social_login/google"  class="btn btn-google">Login with Google<i class="fa fa-google fa-2x"></i></a>\n        </div>\n    </div>\n\n\n    <div class="row no-margin">\n        <div class="no-padding col-md-12 section-item contact-table equidistant">\n          <h4>Have an account with us?</h4>\n        </div>\n    </div>\n\n    <div class="row no-margin">\n        <div class="no-padding col-md-12">\n            <input id="username" name="username" required type="text" class="form-control " placeholder="Username">\n        </div>\n    </div>\n\n    <div class="row no-margin">\n        <div class="no-padding col-md-12">\n            <input id="password" name="password" required type="password" class="form-control " placeholder="Password">\n        </div>\n    </div>\n\n    <div class="row no-margin">\n        <div class="no-padding col-md-12">\n            <label class="remember pull-right" style="padding: 10px">\n                Remember me?\n                <input type="checkbox" name="remember_me" id="remember_me" value="on">\n              </label>\n        </div>\n    </div>\n\n     <div class="row no-margin">\n          <div class="col-sm-12 no-padding">\n              <button type="submit" class="btn btn-success form-control pull-right">Login</button>\n          </div>\n      </div>\n\n    <div class="row no-margin">\n        <div class="no-padding col-md-12">\n            <label class="remember pull-right">\n              Don\'t have an account?\n              <a href="/register" class="btn">Sign Up - It\'s Free.</a>\n            </label>\n        </div>\n    </div>\n</div>\n</form>\n</div>';
    }
    return __p;
};

this["JST"]["profile_edit.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div id="edit-profile-view">\n\n    <div class="row no-margin">\n        <div class="col-xs-12 no-padding">\n           <h4>Edit your profile</h4>\n       </div>\n    </div>\n\n    <div class="row no-margin">\n       <div class="col-xs-12 no-padding">\n           <div id="edit-profile-email"></div>\n       </div>\n    </div>\n\n    <div class="row no-margin">\n       <div class="col-xs-12 no-padding">\n        <input id="edit-profile-name" type="text" class="form-control valid-before-submit" placeholder="John Smith..." data-validation="required">\n       </div>\n    </div>\n\n    <div class="row no-margin username-row">\n        <div class="col-xs-12 no-padding">\n            <input id="edit-profile-username" type="text" class="form-control valid-before-submit" placeholder="username..." data-validation="required">\n        </div>\n    </div>\n\n    <div class="row no-margin password-row">\n        <div class="col-xs-12 no-padding">\n            <input id="edit_profile_password" name="edit_profile_password" type="password" class="form-control" placeholder="password...">\n        </div>\n    </div>\n\n    <div class="row no-margin">\n        <div class="col-xs-12 no-padding">\n            <input name="edit_profile_password_confirm" id="edit_profile_password_confirm" type="password" class="form-control" placeholder=" confirm password...">\n        </div>\n    </div>\n\n    <div class="row no-margin button-row">\n        <div class="col-xs-12 no-padding">\n            <button type=\'button\' class=\'save-profile btn btn-info form-control\'>Save</button>\n        </div>\n    </div>\n\n</div>\n';
    }
    return __p;
};

this["JST"]["register.html"] = function(obj) {
    obj || (obj = {});
    var __t, __p = "", __e = _.escape;
    with (obj) {
        __p += '<div class="signup-container">\n    <div class="signup">\n        <h4>I want in!</h4>\n       <div class="row controls">\n           <div class="col-sm-3"></div>\n            <div class="col-sm-6">\n                <div class="col-sm-9">\n                    <input required type="email" class="form-control register-email" placeholder="Enter email..." data-validation="email">\n                </div>\n                <div class="col-sm-3">\n                    <button type="button" class="btn btn-success form-control submit-register">Go</button>\n                </div>\n            </div>\n            <div class="col-sm-3"></div>\n        </div>\n    </div>\n</div>\n\n<!-- Footer -->\n<div class="section-container footer desktop navbar-fixed-bottom">\n<div class="footer-below">\n    <div class="container">\n      <div class="row">\n          <div class="col-lg-12">\n              Miami, FL<br/>\n              Copyright 2014 &copy; iMeet Inc. All rights reserved.\n          </div>\n      </div>\n    </div>\n</div>\n</div>\n';
    }
    return __p;
};

if (!String.prototype.format) {
    String.prototype.format = function() {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function(match, number) {
            return typeof args[number] != "undefined" ? args[number] : match;
        });
    };
}

function isNullOrEmpty(x_string) {
    return x_string == null || x_string === "";
}

Backbone.Model.prototype.toJSON2 = function() {
    var json = _.clone(this.attributes);
    for (var attr in json) {
        if (json[attr] instanceof Backbone.Model || json[attr] instanceof Backbone.Collection) {
            json[attr] = json[attr].toJSON();
        }
    }
    return json;
};

function guid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == "x" ? r : r & 3 | 8;
        return v.toString(16);
    });
}

function alert_notification(alerts, timeout) {
    $(".alert").remove();
    var alert_string = "" + '<div class="alert alert-{0} alert-dismissible flyover flyover-in" role="alert">' + '<button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>' + "{1}" + "</div>";
    var $alertDiv = $("body");
    alerts.forEach(function(alert) {
        $alertDiv.prepend(alert_string.format(alert.alertType, alert.message));
    });
    if (timeout != null) {
        setTimeout(function() {
            $(".alert").fadeOut(2e3, function() {
                $(".alert").remove();
            });
        }, timeout);
    }
}

var validator = {
    digitsRegex: new RegExp("^[0-9]{10}$"),
    charsRegex: new RegExp(".*"),
    emailRegex: /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
    validateItems: function(selector) {
        var result = true;
        var $elements_to_validate = $(selector);
        $elements_to_validate.each(function(index) {
            var $item = $($elements_to_validate[index]);
            result = validator.validateItem($item) && result;
        });
        return result;
    },
    validateString: function(fieldValue, validation) {
        var passed = false;
        switch (validation) {
          case "required":
            passed = fieldValue.length > 0;
            break;

          case "digits":
            passed = validator.digitsRegex.test(fieldValue);
            break;

          case "non_numerics":
            passed = validator.charsRegex.test(fieldValue);
            break;

          case "email":
            passed = fieldValue.length == 0 || validator.emailRegex.test(fieldValue);
            break;

          case "phone":
            passed = validator.digitsRegex.test(fieldValue) || fieldValue.length == 0;
            break;

          case "date":
            var date = new Date(fieldValue);
            passed = date instanceof Date && !isNaN(date.valueOf());
            break;

          case "time":
            passed = true;
            break;
        }
        return passed;
    },
    validateItem: function($item) {
        var totalResult = true;
        var validations = $item.data("validation");
        validations.split(",").forEach(function(validation) {
            var length = -1;
            if (validation.indexOf(":") >= 0) {
                var split = validation.split(":");
                validation = split[0];
                length = parseInt(split[1]);
            }
            var passed;
            try {
                var fieldValue = $item.val();
                if ($item.is(":checkbox")) {
                    if (!$item.is(":checked")) fieldValue = "";
                }
                if (validation.indexOf("|") != -1) {
                    var composedValidation = function(values, validations) {
                        var validations = validation.split("|");
                        var valueList = values.split(",");
                        if (valueList.length == 0 || validations.length == 0) return true;
                        var allValuesGood = true;
                        valueList.forEach(function(value) {
                            value = value.trim();
                            var atLeastOne = false;
                            validations.forEach(function(validation) {
                                atLeastOne = validator.validateString(value, validation) || atLeastOne;
                            });
                            allValuesGood = allValuesGood && atLeastOne;
                        });
                        return allValuesGood;
                    };
                    passed = composedValidation(fieldValue, validation);
                } else passed = validator.validateString(fieldValue, validation);
                if (length != -1) passed = passed && fieldValue.length == length;
            } catch (err) {
                passed = false;
            }
            totalResult = passed && totalResult;
        });
        if ($item.is(":checkbox")) {
            $item = $item.parent();
        }
        if (!totalResult) this.errorValidationForItem($item); else this.succeedValidationForItem($item);
        return totalResult;
    },
    errorValidationForItem: function($item) {
        this.validationUI($item, true);
    },
    succeedValidationForItem: function($item) {
        this.validationUI($item, false);
    },
    validationUI: function($item, failed) {
        if (failed) $item.addClass("failed-validation"); else $item.removeClass("failed-validation");
        var siblingItems = $item.data("validation-siblings");
        if (siblingItems != null) {
            siblingItems.split(",").forEach(function(sibling) {
                var $sibling = $(sibling);
                if (failed) $sibling.addClass("failed-validation"); else $sibling.removeClass("failed-validation");
            });
        }
    }
};

var randomColor = function getRandomColor() {
    var letters = "0123456789ABCDEF".split("");
    var color = "";
    for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
};

var cut = function cutText(text, length) {
    if (length == null) length = 8;
    if (text.length >= length) return text.substring(0, length) + "...";
    return text;
};

var colorInverter = function invertHex(hexnum) {
    if (hexnum.length != 6) {
        console.error("Hex color must be six hex numbers in length.");
        return false;
    }
    hexnum = hexnum.toUpperCase();
    var splitnum = hexnum.split("");
    var resultnum = "";
    var simplenum = "FEDCBA9876".split("");
    var complexnum = new Array();
    complexnum.A = "5";
    complexnum.B = "4";
    complexnum.C = "3";
    complexnum.D = "2";
    complexnum.E = "1";
    complexnum.F = "0";
    for (i = 0; i < 6; i++) {
        if (!isNaN(splitnum[i])) {
            resultnum += simplenum[splitnum[i]];
        } else if (complexnum[splitnum[i]]) {
            resultnum += complexnum[splitnum[i]];
        } else {
            console.error("Hex colors must only include hex numbers 0-9, and A-F");
            return false;
        }
    }
    return resultnum;
};

window.partial = function(which, data) {
    return JST[which](data);
};

var fetchGroupDistributionForCurrentUser = function(callback) {
    if (currentUser == null) {
        callback({
            contacts: [],
            groups: []
        });
    } else {
        $.ajax({
            url: "/api/contacts/groups?user_id=" + currentUser.id,
            type: "GET",
            success: function(data) {
                if (callback != null) callback(data);
            },
            error: function(data) {}
        });
    }
};

IMeetCollection = Backbone.Collection.extend({
    getById: function(unique_id) {
        var result = this.filter(function(val) {
            return val.get("unique_id") === unique_id;
        });
        if (result.length > 0) return result[0];
        return null;
    },
    removeBy: function(unique_id) {
        this.remove(this.getById(unique_id));
    },
    collectionToJSON: function() {
        return this.map(function(model) {
            return model.toJSON2();
        });
    }
});

Contact = Backbone.Model.extend({
    defaults: {
        unique_id: "",
        name: "",
        email: "",
        phone: ""
    },
    includeInInvite: function(invite_id, view, callback) {
        var url = "/api/invite/" + invite_id + "/attendees/";
        var attendees = [ this.toJSON() ];
        var post = {
            attendees: attendees
        };
        if (currentUser != null) {
            post.user_id = currentUser.id;
        }
        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(post),
            cache: false,
            success: function(data) {
                if (callback) callback(view, data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    removeFromInvite: function(invite_id, callback) {
        var url = "/api/invite/" + invite_id + "/attendees/" + this.get("unique_id");
        $.ajax({
            url: url,
            type: "DELETE",
            contentType: "application/json",
            cache: false,
            success: function(data) {
                if (callback) callback(view, data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    acknowledgeInvite: function(response, callback) {
        var url = "/api/invite/attendees/" + this.get("unique_id") + "/response";
        var post = {
            response: response,
            channel: "web"
        };
        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(post),
            cache: false,
            success: function(data) {
                if (callback != null) callback(data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    create: function(callback) {
        $.ajax({
            url: "/api/contacts",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                user_id: currentUser.id,
                contact: this.toJSON()
            }),
            cache: false,
            success: function(unique_id) {
                if (callback != null) callback(unique_id);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    update: function(callback) {
        var unique_id = this.get("unique_id");
        var user_id = currentUser.id;
        $.ajax({
            url: api.url + "api/contacts/" + unique_id + "/edit",
            data: JSON.stringify({
                user_id: user_id,
                contact: {
                    name: this.get("name"),
                    email: this.get("email"),
                    phone: this.get("phone")
                }
            }),
            type: "PUT",
            contentType: "application/json",
            cache: false,
            success: function(data) {
                if (callback != null) callback(data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    deleteContact: function(callback) {
        var unique_id = this.get("unique_id");
        $.ajax({
            url: api.url + "api/contacts/" + currentUser.id + "/delete/" + unique_id,
            type: "DELETE",
            contentType: "application/json",
            cache: false,
            success: function(data) {
                if (callback != null) callback(data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    someIdentifier: function() {
        var name = this.get("name");
        if (name != null && name !== "") return name;
        name = this.get("email");
        if (name != null && name !== "") return name;
        name = this.get("phone");
        return name;
    }
});

ContactList = IMeetCollection.extend({
    model: Contact
});

Group = Backbone.Model.extend({
    defaults: {
        unique_id: "",
        name: "",
        contacts: new ContactList()
    },
    fetchContacts: function(callback) {
        $.ajax({
            url: "/api/group/" + this.get("unique_id") + "?user_id=" + currentUser.id,
            type: "GET",
            success: function(data) {
                var contactList = new ContactList();
                data.forEach(function(item) {
                    contactList.add(new Contact(item));
                });
                callback(contactList);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: "There was an error getting the contacts for the group"
                } ]);
            }
        });
    },
    includeInInvite: function(invite_id, callback) {
        var url = "/api/invite/" + invite_id + "/group/";
        var post = {
            user_id: currentUser.id,
            unique_id: this.get("unique_id")
        };
        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(post),
            cache: false,
            success: function(data) {
                if (callback) callback(view, data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    }
});

GroupList = IMeetCollection.extend({
    model: Group,
    localStorage: new Store("backbone-group")
});

InviteModel = Backbone.Model.extend({
    defaults: {
        unique_id: "",
        title: "",
        start_date: "",
        start_time: "",
        end_date: "",
        end_time: "",
        description: "",
        where: "",
        poster_image_id: "",
        attendees: new ContactList(),
        all_contacts: new ContactList(),
        all_groups: new ContactList(),
        utc_offset: 0
    },
    initialize: function(options) {
        if (options == null) return;
        var start_datetime = this.parse_datetime(options.start);
        var end_datetime = this.parse_datetime(options.end);
        this.set("start_date", start_datetime.date);
        this.set("start_time", start_datetime.time);
        this.set("end_date", end_datetime.date);
        this.set("end_time", end_datetime.time);
        var attendees = new ContactList();
        if (options.attendees != null) options.attendees.forEach(function(item) {
            attendees.push(new Contact(item));
        });
        this.set("attendees", attendees);
    },
    format_date: function(property, format) {
        var _date = this.get(property);
        if (isNullOrEmpty(_date)) return null;
        return moment(_date).format(format);
    },
    get_datetime: function(property) {
        var time = this.get(property + "_time");
        var date = this.get(property + "_date");
        if (isNullOrEmpty(time) || isNullOrEmpty(date)) return null;
        return date + " " + time;
    },
    parse_datetime: function(datetime) {
        if (isNullOrEmpty(datetime)) return {
            date: null,
            time: null
        };
        var moment_obj = moment(datetime);
        return {
            date: moment_obj.format("MM/D/YYYY"),
            time: moment_obj.format("hh:mm A")
        };
    },
    toJSON: function() {
        var json = Backbone.Model.prototype.toJSON.apply(this, arguments);
        json["start"] = this.get_datetime("start");
        json["end"] = this.get_datetime("end");
        return json;
    },
    fetch: function(callback) {
        var that = this;
        $.ajax({
            url: "/api/invite/" + this.get("unique_id"),
            type: "GET",
            cache: false,
            success: function(data) {
                callback(that.get("unique_id"), data);
            }
        });
    },
    updateTitle: function(callback, enableNotifications) {
        var that = this;
        var url = "/api/invite/" + this.get("unique_id") + "/title";
        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                title: this.get("title")
            }),
            cache: false,
            success: function(data) {
                if (enableNotifications) alert_notification([ {
                    alertType: "success",
                    message: "Event saved successfully!"
                } ], 3e3);
                callback(data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    updateDescription: function(callback, enableNotifications) {
        var that = this;
        var url = "/api/invite/" + this.get("unique_id") + "/description";
        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                description: this.get("description")
            }),
            cache: false,
            success: function(data) {
                if (enableNotifications) alert_notification([ {
                    alertType: "success",
                    message: "Event saved successfully!"
                } ], 3e3);
                callback(data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    submit: function(callback, enableNotifications) {
        var that = this;
        var d = new Date();
        this.set("utc_offset", d.getTimezoneOffset());
        var invite = this.toJSON();
        if (currentUser != null) invite.user_id = currentUser.id;
        var url = "/api/invite/";
        if (this.get("unique_id") !== null) url += this.get("unique_id");
        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(invite),
            cache: false,
            success: function(data) {
                if (enableNotifications) alert_notification([ {
                    alertType: "success",
                    message: "Event saved successfully!"
                } ], 3e3);
                callback(data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    notifyAll: function(callback) {
        var invite = this.toJSON();
        $.ajax({
            url: "/api/invite/" + this.get("unique_id") + "/attendees/notify/all",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(invite),
            cache: false,
            success: function(data) {
                callback(data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    }
});

InviteList = IMeetCollection.extend({
    model: InviteModel
});

CommentModel = Backbone.Model.extend({
    defaults: {
        on: null,
        comment: "",
        author: ""
    },
    initialize: function(options) {
        if (typeof options == "string") this.set("comment", options);
    },
    submit: function(invite_id, invite_attendee_id) {
        var url = "/api/invite/{0}/comment".format(invite_id);
        if (invite_attendee_id != null) url = "/api/invite/{0}/attendees/{1}/comment".format(invite_id, invite_attendee_id);
        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                comment: this.get("comment")
            }),
            cache: false,
            success: function(data) {},
            error: function(data) {
                if (data.status != 200) alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    }
});

CommentList = IMeetCollection.extend({
    model: CommentModel,
    fetchFromInvite: function(invite_unique_id) {
        $.ajax({
            url: "/api/invite/{0}/comment".format(invite_unique_id),
            type: "GET",
            contentType: "application/json",
            cache: false,
            success: function(data) {
                var comments = new CommentList();
                data.forEach(function(comment) {
                    comments.add(new CommentModel(comment));
                });
                return comments;
            },
            error: function(data) {}
        });
    }
});

SimpleView = Backbone.View.extend({
    initialize: function(options) {
        this.options = options || {};
    },
    hidePanels: function() {
        $("#body-container").hide();
        $("#view-container").show();
        $("#modal_container").hide();
        $("#invite-body").hide();
    },
    clearTemplate: function() {
        $("#view-container").html("");
    },
    block: function(el, ratio) {
        var h = $(window).height();
        if (ratio === "half") h = h / 2; else if (ratio == "quarter") h = h / 3; else h = h;
        $(el).css("height", h);
    }
});

var _contactCreateView = null;

function contactCreateView() {
    if (_contactCreateView == null) _contactCreateView = new ContactDetailsView();
    return _contactCreateView;
}

ContactsView = SimpleView.extend({
    first_time: true,
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .add-contact": "addContact",
        "change #import-csv": "importFromCsv",
        "click .add-group": "addGroup",
        "mouseup div": "mouseUp"
    },
    render: function(options) {
        $("#contact-list").show();
        $("#contact-new").hide();
        if (!this.first_time) {
            return;
        }
        this.contactList = options.contactList;
        this.groupList = options.groupList;
        this.listenTo(this.contactList, "add", this.addContactHook);
        this.listenTo(this.contactList, "remove", this.removeContactHook);
        this.listenTo(this.contactList, "change", this.changeContactHook);
        var groupsTable = $(".groups_table");
        var contactTable = $("#contacts_table");
        contactList.each(function(contact) {
            contactTable.append(new ContactItemView({
                model: contact
            }).render().el);
        });
        this.groupListView = new GroupListView({
            el: ".groups_table"
        });
        this.groupListView.render({
            groupList: this.groupList,
            contactList: this.contactList
        });
        this.first_time = false;
    },
    addContactHook: function(contact) {
        var contactTable = $("#contacts_table");
        contactTable.append(new ContactItemView({
            model: contact
        }).render().el);
    },
    removeContactHook: function(data) {
        var $contact_row = $('div[data-id="' + data.get("unique_id") + '"');
        $contact_row.remove();
    },
    changeContactHook: function(contact) {
        var $contact_row = $('div[data-id="' + contact.get("unique_id") + '"');
        $contact_row.html($(JST["contact_item.html"](contact.toJSON())).html());
    },
    addContact: function(evt) {
        evt.preventDefault();
        this.contactCreateView = contactCreateView();
        this.contactCreateView.render(null, this.contactList);
    },
    addGroup: function() {
        this.groupListView.showDialog();
    },
    importFromCsv: function(evt) {
        var reader = new FileReader();
        reader.onload = function(theFile, that) {
            return function(e) {
                $.ajax({
                    url: "/api/contacts/csv",
                    type: "POST",
                    contentType: "application/json",
                    data: '{"user_id" : "{0}", "file_name": "{1}", "file": "{2}"}'.format(currentUser.id, theFile.name, e.target.result),
                    cache: false,
                    success: function() {
                        location.reload();
                        console.info("file uploaded correctly.");
                    },
                    error: function(data) {
                        alert_notification([ {
                            alertType: "danger",
                            message: data.responseText
                        } ]);
                    }
                });
            };
        }(evt.target.files[0], this);
        reader.readAsDataURL(evt.target.files[0]);
    }
});

ContactDetailsView = Backbone.View.extend({
    template: JST["contact_details.html"],
    el: "#new-contact-container",
    createMode: true,
    mainContactList: null,
    events: {
        "click .new-contact-btn": "newContact"
    },
    render: function(contactModel, mainContactList) {
        this.mainContactList = mainContactList;
        if (contactModel != null) this.createMode = false; else this.createMode = true;
        this.model = contactModel || new Contact();
        this.$el.html(this.template({
            createMode: this.createMode,
            contact: this.model.toJSON()
        }));
        this.$el.find(".addContact-modal").modal({
            show: true,
            backdrop: true,
            keyboard: true
        });
        return this.$el;
    },
    show: function() {
        this.$el.find(".addContact-modal").modal({
            show: true,
            backdrop: true,
            keyboard: true
        });
    },
    hide: function() {
        this.$el.find(".addContact-modal").modal("hide");
    },
    newContact: function() {
        if (!validator.validateItems(".contact_input")) {
            alert_notification([ {
                alertType: "warning",
                message: "You have incorrect or missing fields!"
            } ]);
            return;
        }
        this.model.set("name", $("#nameInput").val());
        this.model.set("email", $("#emailInput").val());
        this.model.set("phone", $("#phoneInput").val());
        if (this.createMode) this.model.create($.proxy(this.contactCreated, this)); else this.model.update($.proxy(this.contactCreated, this));
    },
    contactCreated: function(data) {
        var message = this.createMode ? "Contact created!" : "Contact updated!";
        alert_notification([ {
            alertType: "success",
            message: message
        } ], 5);
        this.model.set("unique_id", data);
        if (this.mainContactList != null) this.mainContactList.add(this.model);
        this.hide();
    }
});

ContactItemView = SimpleView.extend({
    template: JST["contact_item.html"],
    editTemplate: JST["contact_item_edit.html"],
    model: null,
    editMode: false,
    events: {
        "dragstart .contact-row": "enterDragMode",
        "click .contact-row": "edit",
        "click .finish-edit": "finishEditMode",
        "click .delete-contact": "deleteContact"
    },
    render: function() {
        this.$el.html(this.template(this.model.toJSON()));
        return this;
    },
    enterDragMode: function(ev) {
        var unique_id = this.model.get("unique_id");
        ev.originalEvent.dataTransfer.setData("contact_id", unique_id);
    },
    edit: function(evt) {
        evt.preventDefault();
        this.contactCreateView = contactCreateView();
        this.contactCreateView.render(this.model);
    },
    deleteContact: function(evt) {
        evt.preventDefault();
        evt.stopPropagation();
        this.model.deleteContact($.proxy(this.contactDeleted, this));
    },
    contactDeleted: function(unique_id) {}
});

GroupListView = Backbone.View.extend({
    events: {
        "dragover .group-drop-area": "contactDragOver",
        "dragenter .group-drop-area": "contactDragEnter",
        "dragleave .group-drop-area": "contactDragLeave",
        "drop .group-drop-area": "contactDropped"
    },
    newGroupView: null,
    render: function(options) {
        this.groupList = options.groupList;
        this.contactList = options.contactList;
        var that = this;
        var index = 0;
        if (groupList.length > 0) this.groupList.forEach(function(group) {
            var group_json = group.toJSON2();
            group_json.panel_class = false && index % 2 == 0 ? "group-panel-even" : "group-panel-odd";
            that.$el.append(JST["group-item.html"](group_json));
            index++;
        }); else {
            that.$el.append("<div class='empty-groups'>You have no groups. Create one!</div>");
        }
        this.$groupsTable = this.$el;
        this.listenTo(this.groupList, "add", this.newGroupAdded);
        this.listenTo(this.groupList, "remove", this.removedGroup);
        this.newGroupView = new GroupCreateView();
        this.$el.append(this.newGroupView.render({
            groupList: this.groupList
        }));
        return this.$el;
    },
    showDialog: function() {
        this.newGroupView.show();
    },
    newGroupAdded: function(group) {
        $("empty-groups").hide();
        var group_json = group.toJSON();
        group_json.panel_class = this.groupList.length % 2 == 0 ? "group-panel-even" : "group-panel-odd";
        this.$el.prepend(JST["group-item.html"](group_json));
    },
    removedGroup: function() {},
    contactDragEnter: function(ev) {
        ev.preventDefault();
        var $item = $(ev.target);
        if ($item.hasClass("group-drag-hover") || !$item.hasClass("group-drop-area")) return;
        $item.addClass("group-drag-hover");
    },
    contactDragLeave: function(ev) {
        ev.preventDefault();
        var $item = $(ev.target);
        if (!$item.hasClass("group-drag-hover") || !$item.hasClass("group-drop-area")) return;
        $item.removeClass("group-drag-hover");
    },
    contactDragOver: function(ev) {
        ev.preventDefault();
    },
    contactDropped: function(ev) {
        var $group = $(ev.target);
        if (!$group.hasClass("group-drop-area")) return;
        ev.preventDefault();
        ev.stopPropagation();
        var id = $group.data("id");
        var group = this.groupList.getById(id);
        if (group != null) {
            var contact_unique_id = ev.originalEvent.dataTransfer.getData("contact_id");
            var contact = this.contactList.getById(contact_unique_id);
            if (contact != null) this.addContactToGroup(contact, group);
        }
        $group.removeClass("group-drag-hover");
    },
    addContactToGroup: function(contact, group) {
        $.ajax({
            url: "/api/group/" + group.attributes.unique_id + "/" + contact.attributes.unique_id + "?user_id=" + currentUser.id,
            type: "POST",
            contentType: "application/json",
            success: function(data) {
                $("#groupbox_" + group.get("unique_id")).append('<div class="col-md-5 group-contact">' + cut(contact.get("name"), 8) + "</div>");
            },
            error: function(data) {
                console.log(data);
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    }
});

GroupCreateView = Backbone.View.extend({
    template: JST["add-group.html"],
    events: {
        "click .new-group-btn": "newGroup",
        "keyup .new-group-input": "newGroupKeyEvent"
    },
    render: function(options) {
        this.groupList = options.groupList;
        this.$el.html(this.template());
        this.$groupInput = this.$el.find(".new-group-input");
        return this.$el;
    },
    show: function() {
        this.$el.find(".addGroup-modal").modal({
            show: true,
            backdrop: true,
            keyboard: true
        });
        this.$groupInput.focus();
    },
    hide: function() {
        this.$el.find(".addGroup-modal").hide();
    },
    newGroupKeyEvent: function(evt) {
        if (evt.keyCode != 13) {
            return;
        }
        this.newGroup();
    },
    newGroup: function() {
        var that = this;
        var name = this.$groupInput.val();
        if (name == "") {
            alert_notification([ {
                alertType: "warning",
                message: "Type a name for the group!"
            } ]);
            return;
        }
        this.hide();
        $.ajax({
            url: "/api/group/" + name + "?user_id=" + currentUser.id,
            type: "POST",
            success: function(data) {
                alert_notification([ {
                    alertType: "success",
                    message: "Group Added!"
                } ]);
                that.groupList.add(new Group(data));
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: "Problem adding the Group!"
                } ]);
            }
        });
    }
});

IndexView = Backbone.View.extend({
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .imeet-btn": "createNew",
        "keypress .invite-title-input": "type_key"
    },
    type_key: function(e) {
        if (e.keyCode == 13) {
            this.createNew();
            e.preventDefault();
            return false;
        }
    },
    render: function(data) {
        $("#view-container").hide();
        this.$el.show();
        this.$inviteTitle = this.$el.find(".invite-title-input");
        this.$headerImage = this.$el.find(".header-section");
    },
    createNew: function() {
        var viewName = this.$inviteTitle.val();
        if (viewName != null && viewName != "") Backbone.history.navigate("/new/" + viewName, true); else alert("type a title!");
    }
});

InviteAdminView = SimpleView.extend({
    template: JST["invite_admin.html"],
    author: "Organizer",
    contacts: null,
    current_attendee: null,
    initialize: function(options) {
        this.options = options || {};
        this.inviteId = this.options.id;
    },
    events: {
        "keypress .invite-newComment": "addNewComment",
        "click .notify-all": "notifyAll",
        "change .share_to_facebook": "share_on_facebook_auth"
    },
    hidePanels: function() {
        $("#body-container").hide();
        $("#view-container").hide();
        $("#modal_container").hide();
        $("#invite-body").show();
    },
    render: function(unique_id, invite, invite_attendee) {
        this.hidePanels();
        this.unique_id = unique_id;
        if (this.unique_id == null) console.error("Invite Id is null, check routing");
        if (invite == null) {
            var inviteModel = new InviteModel({
                unique_id: this.unique_id
            });
            inviteModel.fetch($.proxy(this.render, this));
            return;
        }
        if (invite_attendee != null) this.current_attendee = new Contact(invite_attendee);
        this.validateInviteIsCurrent(invite.start);
        this.model = new InviteModel(invite);
        var invite_json = this.model.toJSON();
        this.$el.html(this.template(invite_json));
        var invite_attendees_view = new InviteAttendeesView();
        var invite_description = new InviteDescriptionView({
            el: "#invite-description"
        });
        var invite_header = new InviteHeaderView({
            is_admin: true
        });
        var invite_details = new InviteDetailsView({
            is_admin: true
        });
        var invite_comments = new InviteCommentsView();
        var invite_attendee_create = new InviteAttendeeCreateView();
        var invite_attendees = this.model.get("attendees");
        invite_attendees_view.render({
            invite_id: this.invite_id,
            attendees: invite_attendees,
            current_attendee: this.current_attendee
        });
        invite_description.render(this.model);
        invite_header.render(this.model);
        invite_details.render(this.model);
        invite_comments.render({
            invite_id: this.unique_id,
            current_attendee: this.current_attendee,
            comments: new CommentList(invite.comments)
        });
        invite_attendee_create.render(this.unique_id, invite_attendees);
        $(".invite-description").html(invite.description);
        this.plugins();
    },
    notifyAll: function() {
        this.model.notifyAll($.proxy(this.notifyAllCallback, this));
    },
    notifyAllCallback: function(result) {
        alert_notification([ {
            alertType: "success",
            message: "Everyone in the invite is going to be notified in the next few minutes"
        } ], 5e3);
    },
    plugins: function() {
        var that = this;
        that.block(".invite-background", "half");
        $(window).resize(function() {
            that.block(".invite-background", "half");
        });
    },
    validateInviteIsCurrent: function(start) {
        var moment_obj = moment(start);
        var now = moment();
        if (moment_obj < now) {
            alert_notification([ {
                alertType: "warning",
                message: "This invite is in the Past you cannot edit it anymore"
            } ], 5e3);
        }
    }
});

InviteAttendeeCreateView = Backbone.View.extend({
    template: JST["invite_attendee_create.html"],
    el: "#invite-new-attendee",
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .new-contact-button": "createNewAttendee",
        "keyup .contact-input": "newAttendeeEnter"
    },
    render: function(invite_id, inviteAttendees) {
        this.model = inviteAttendees;
        this.invite_id = invite_id;
        var json = {};
        this.$el.html(this.template(json));
        this.$newContact = $(".contact-input");
        var that = this;
        fetchGroupDistributionForCurrentUser(function(contacts_and_groups) {
            that.all_contacts = new ContactList(contacts_and_groups.contacts);
            that.all_groups = new GroupList(contacts_and_groups.groups);
            that.setupContactsTypeahead();
        });
    },
    newAttendeeEnter: function(evt) {
        if (evt.keyCode != 13) {
            return;
        }
        this.createNewAttendee();
    },
    createNewAttendee: function() {
        var contact = null;
        var group = null;
        if (this.last_selected_item != null && this.last_selected_item.is_group) group = this.last_selected_item; else if (this.last_selected_item != null) {
            contact = this.last_selected_item;
        }
        if (this.last_selected_item == null && this.$newContact.val() != "") {
            if (!validator.validateItem(this.$newContact)) {
                alert_notification([ {
                    alertType: "warning",
                    message: "You have incorrect or missing fields!"
                } ]);
                return;
            }
            var emailAndPhone = this.parsePhoneAndEmail(this.$newContact.val());
            contact = {
                unique_id: guid(),
                name: "",
                email: emailAndPhone.email,
                phone: emailAndPhone.phone
            };
        }
        if (contact != null) {
            var contactModel = new Contact(contact);
            this.model.add(contactModel);
            contactModel.includeInInvite(this.invite_id);
        }
        if (group != null) {
            var group = new Group({
                unique_id: group.unique_id
            });
            group.fetchContacts($.proxy(this.addAttendeesFromGroup, this));
            group.includeInInvite(this.invite_id);
        }
        this.last_selected_item = null;
        this.$newContact.val("");
        this.$newContact.typeahead("val", "");
        this.$newContact.focus();
    },
    addAttendeesFromGroup: function(attendeeList) {
        var that = this;
        attendeeList.forEach(function(item) {
            that.model.add(item);
        });
    },
    setupContactsTypeahead: function() {
        var that = this;
        var substringMatcher = function(contacts) {
            return function findMatches(q, cb) {
                var matches, substrRegex;
                matches = [];
                substrRegex = new RegExp(q, "i");
                contacts.each(function(contact) {
                    if (substrRegex.test(contact.get("name")) || substrRegex.test(contact.get("email")) || substrRegex.test(contact.get("phone"))) matches.push(contact.toJSON());
                });
                cb(matches);
            };
        };
        var substringGroupMatcher = function(groups) {
            return function findMatches(q, cb) {
                var matches, substrRegex;
                matches = [];
                substrRegex = new RegExp(q, "i");
                groups.each(function(group) {
                    if (substrRegex.test(group.get("name"))) {
                        group.set("is_group", true);
                        matches.push(group.toJSON());
                    }
                });
                cb(matches);
            };
        };
        var setupTypeAhead = function(contacts, groups) {
            that.$newContact.typeahead({
                hint: true,
                highlight: true,
                minLength: 1
            }, {
                autoselect: true,
                name: "groups",
                displayKey: "name",
                source: substringGroupMatcher(groups),
                templates: {
                    suggestion: JST["group_item_typeahead.html"]
                }
            }, {
                autoselect: true,
                name: "contacts",
                displayKey: "name",
                source: substringMatcher(contacts),
                templates: {
                    suggestion: JST["contact_item_typeahead.html"]
                }
            }).on("typeahead:selected", function(obj, data) {
                that.last_selected_item = data;
            }).on("keypress keydown input", function($e) {
                $e.stopPropagation();
            });
        };
        setupTypeAhead(that.all_contacts, that.all_groups);
    },
    parsePhoneAndEmail: function(addressString) {
        var trimmedAddressString = addressString.trim();
        var addresses = addressString.split(";");
        if (addresses.length == 1) addresses = addressString.split(",");
        for (var i = 0; i < addresses.length; i++) addresses[i] = addresses[i].trim();
        if (addresses.length == 1) {
            if (isNaN(addresses[0])) return {
                email: addresses[0],
                phone: ""
            }; else return {
                phone: addresses[0],
                email: ""
            };
        } else {
            if (isNaN(addresses[0])) return {
                email: addresses[0],
                phone: addresses[1]
            }; else return {
                phone: addresses[0],
                email: addresses[1]
            };
        }
    }
});

InviteAttendeesView = Backbone.View.extend({
    template: JST["invite_attendees.html"],
    el: "#invite-attendees",
    confirmed: null,
    negated: null,
    no_response: null,
    current_attendee: null,
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .invite-attendees-acknowledge-yes": "yesButtonClick",
        "click .invite-attendees-acknowledge-no": "noButtonClick"
    },
    render: function(data) {
        this.model = data.attendees;
        this.current_attendee = data.current_attendee;
        this.invite_id = data.invite_id;
        this.separateAttendees();
        var json = {
            no_response: this.no_response.collectionToJSON(),
            confirmed: this.confirmed.collectionToJSON(),
            negated: this.negated.collectionToJSON(),
            attendee: this.current_attendee != null ? this.current_attendee.toJSON() : null
        };
        this.$el.html(this.template(json));
        this.$table = this.$el.find(".contact-table");
        this.$newContact = $(".contact-input");
        this.listenTo(this.model, "add", this.attendeeCreated);
        this.listenTo(this.model, "remove", this.attendeeRemoved);
        return this.$el.html();
    },
    separateAttendees: function() {
        this.no_response = new ContactList();
        this.negated = new ContactList();
        this.confirmed = new ContactList();
        var that = this;
        this.model.forEach(function(item) {
            var status = item.get("status");
            if (status == "yes") {
                that.confirmed.add(item);
            } else if (status == "no") {
                that.negated.add(item);
            } else if (status == "organizer") {
                item.set("organizer", true);
                that.confirmed.add(item);
            } else {
                that.no_response.add(item);
            }
        });
    },
    attendeeCreated: function(attendeeModel) {
        this.no_response.add(attendeeModel);
        $(".no-response-table").prepend(JST["invite_attendee.html"](attendeeModel.toJSON()));
    },
    attendeeRemoved: function(e) {
        var dataId = $(e.currentTarget).data("rowid");
        var contactModel = this.model.getById(dataId);
        contactModel.removeFromInvite(this.invite_id);
        this.model.removeBy(dataId);
    },
    yesButtonClick: function(event) {
        this.attendeeRSVP("yes");
    },
    noButtonClick: function(event) {
        this.attendeeRSVP("no");
    },
    attendeeRSVP: function(response) {
        if (this.current_attendee == null) {
            alert_notification([ {
                alertType: "danger",
                message: "Something wrong happened, you shouldnt be able to SAY " + response + " You are nobody!!!"
            } ]);
            return;
        }
        this.current_attendee.set("status", response);
        this.current_attendee.acknowledgeInvite(response, $.proxy(this.attendeeRSVPCallback, this));
    },
    attendeeRSVPCallback: function() {
        var attendee_model = this.model.getById(this.current_attendee.get("unique_id"));
        attendee_model.set("status", this.current_attendee.get("status"));
        this.render({
            attendees: this.model,
            current_attendee: this.current_attendee
        });
    }
});

InviteCommentsView = Backbone.View.extend({
    template: JST["invite_comments.html"],
    el: "#invite-comments",
    invite_id: null,
    current_attendee: null,
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .add-comment": "addComment",
        "keyup .invite-comment-input": "addCommentEnter"
    },
    render: function(data) {
        this.invite_id = data.invite_id;
        this.current_attendee = data.current_attendee;
        this.model = data.comments;
        var json = {
            comments: this.model.collectionToJSON()
        };
        this.$el.html(this.template(json));
        this.$comment_container = this.$el.find(".invite-comments-container");
        this.$comment_input = this.$el.find(".invite-comment-input");
        this.listenTo(this.model, "add", this.newCommentModel);
    },
    addCommentEnter: function(evt) {
        if (evt.keyCode != 13) {
            return;
        }
        this.addComment();
    },
    addComment: function() {
        if (this.$comment_input.val() == "") return;
        var comment = new CommentModel({
            comment: this.$comment_input.val(),
            author: this.current_attendee != null ? this.current_attendee.someIdentifier() : null
        });
        comment.submit(this.invite_id, this.current_attendee != null ? this.current_attendee.get("unique_id") : null);
        this.model.add(comment);
        this.$comment_input.val("");
        this.$comment_input.focus();
    },
    newCommentModel: function(commentModel) {
        this.$comment_container.prepend(JST["invite_comment.html"](commentModel.toJSON()));
    }
});

InviteCreateView = SimpleView.extend({
    el: "#view-container",
    initialize: function(options) {
        this.options = options || {};
        this.model = new InviteModel();
    },
    events: {
        "click .send": "submitNew",
        "change .share_to_facebook": "share_on_facebook_auth"
    },
    bindings: {
        ".event-name": "title",
        ".event-name-input": "title",
        ".event-description": "description",
        ".event-description-input": "description",
        ".event-where": "where",
        ".event-location-input": "where",
        ".event-start-date": "start_date",
        ".event-start-time": "start_time",
        ".event-end-date": "end_date",
        ".event-end-time": "end_time"
    },
    template: JST["invite_create.html"],
    contacts: null,
    render: function(options) {
        this.hidePanels();
        if (options.title != null) this.model.set("title", options.title);
        if (options.id != null) this.createFromInvite(options.id);
        this.$el.html(this.template(this.model.toJSON()));
        this.plugins();
        this.stickit();
        return this;
    },
    createFromInvite: function(source_invite_id) {
        var that = this;
        $.ajax({
            url: "/api/invite/" + source_invite_id,
            type: "GET",
            cache: false,
            success: function(data) {
                that.model = new InviteModel(data);
                that.model.set("unique_id", "");
                that.render(data);
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    },
    submitNew: function(e) {
        var that = this;
        if (!validator.validateItems(".valid-before-submit")) {
            alert_notification([ {
                alertType: "warning",
                message: "You have incorrect or missing fields!"
            } ]);
            return;
        }
        this.model.submit($.proxy(this.inviteSubmitted, this), true);
    },
    inviteSubmitted: function(result) {
        Backbone.history.navigate("invite/" + result + "/edit", true);
    },
    share_on_facebook_auth: function() {
        if (currentUser != null && currentUser.social_sharing.facebook || !$("#bt_toggle").is(":checked")) return;
        window.open(api.url + "/social_sharing/facebook", "_blank", "toolbar=yes, scrollbars=no, resizable=yes, top=500, left=500");
    },
    plugins: function() {
        $("#bt_toggle").bootstrapToggle();
        this.$el.find(".event-start-date, .event-end-date").datetimepicker({
            pickTime: false,
            minDate: moment()
        });
        this.$el.find(".event-start-time, .event-end-time").datetimepicker({
            pickDate: false,
            minDate: moment().add(-10, "m")
        });
        this.initWhere();
    },
    initWhere: function() {
        var that = this;
        if (typeof google === "undefined") return;
        this.$where = this.$el.find(".event-location-input");
        autocomplete = new google.maps.places.Autocomplete(that.$where[0], {
            types: [ "geocode" ]
        });
        var fillAddress = function() {
            var place = autocomplete.getPlace();
            that.model.set("where", place.formatted_address);
        };
        google.maps.event.addListener(autocomplete, "place_changed", function() {
            fillAddress();
        });
    },
    geoLocateWhere: function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var geolocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                var circle = new google.maps.Circle({
                    center: geolocation,
                    radius: position.coords.accuracy
                });
                autocomplete.setBounds(circle.getBounds());
            });
        }
    }
});

InviteDescriptionView = Backbone.View.extend({
    is_editable: true,
    initialize: function(options) {
        this.options = options || {};
    },
    render: function(model, edit_view) {
        var that = this;
        this.model = model;
        if (!edit_view) {
            var label = '<span class="editable invite-description-value">' + that.model.get("description") + "</span>";
            this.$el.html(label);
            if (this.is_editable) {
                var $label = this.$el.find(".invite-description-value");
                $label.on("click", function() {
                    that.render(that.model, true);
                });
            }
        } else {
            var input = '<textarea type="text" class="edit-invite-description-input">' + that.model.get("description") + "</textarea>";
            this.$el.html(input);
            this.$input = this.$el.find(".edit-invite-description-input");
            var update = function(value) {
                that.model.set("description", value);
                that.model.updateDescription($.proxy(that.submitSuccess, that));
            };
            this.$input.on("blur", function() {
                update(that.$input.val());
            });
            this.$input.on("keyup", function(evt) {
                if (evt.keyCode != 13) {
                    return;
                }
                update(that.$input.val());
            });
        }
    },
    submitSuccess: function(result) {
        this.render(this.model, false);
    }
});

InviteDetailsView = SimpleView.extend({
    template: JST["invite_details.html"],
    el: "#invite-details",
    bindings: {
        ".event-name": "title",
        ".event-name-input": "title",
        ".event-description": "description",
        ".event-description-input": "description",
        ".event-where": "where",
        ".event-location-input": "where",
        ".event-start-date": "start_date",
        ".event-start-time": "start_time",
        ".event-end-date": "end_date",
        ".event-end-time": "end_time"
    },
    initialize: function(options) {
        this.options = options || {};
        this.inviteId = this.options.id;
    },
    events: {
        "click .invite-date": "edit_start_date",
        "click .invite-end-date": "edit_end_date",
        "click .location-title": "edit_location",
        "click .edit_invite": "editInvite",
        "click .save_invite": "saveInvite"
    },
    render: function(invite_model, edit_view) {
        this.model = invite_model;
        var invite_json = this.model.toJSON();
        invite_json["is_admin"] = this.options.is_admin;
        invite_json["is_edit"] = edit_view;
        this.$el.html(this.template(invite_json));
        if (edit_view) {
            this.edit_plugins();
            this.stickit();
        } else {
            this.read_plugins();
        }
    },
    editInvite: function() {
        this.render(this.model, true);
    },
    saveInvite: function() {
        if (!validator.validateItems(".valid-before-submit")) {
            alert_notification([ {
                alertType: "warning",
                message: "You have incorrect or missing fields!"
            } ]);
            return;
        }
        if (($(".event-end-date").val() != "" || $(".event-end-time").val() != "") && !validator.validateItems(".event-end-date, .event-end-time")) {
            alert_notification([ {
                alertType: "warning",
                message: "You have incorrect or missing fields!"
            } ]);
            return;
        }
        this.model.submit($.proxy(this.submitSuccess, this));
    },
    submitSuccess: function(result) {
        this.render(this.model, false);
    },
    read_plugins: function() {
        $("#bt_toggle").bootstrapToggle();
    },
    edit_plugins: function() {
        this.$el.find(".event-start-date, .event-end-date").datetimepicker({
            pickTime: false
        });
        this.$el.find(".event-start-time, .event-end-time").datetimepicker({
            pickDate: false
        });
        this.initWhere();
        $("#bt_toggle").bootstrapToggle();
    },
    initWhere: function() {
        var that = this;
        if (typeof google === "undefined") return;
        that.$where = this.$el.find(".event-location-input");
        autocomplete = new google.maps.places.Autocomplete(that.$where[0], {
            types: [ "geocode" ]
        });
        var fillAddress = function() {
            var place = autocomplete.getPlace();
            that.model.set("where", place.formatted_address);
        };
        google.maps.event.addListener(autocomplete, "place_changed", function() {
            fillAddress();
        });
    },
    geoLocateWhere: function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var geolocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                var circle = new google.maps.Circle({
                    center: geolocation,
                    radius: position.coords.accuracy
                });
                autocomplete.setBounds(circle.getBounds());
            });
        }
    },
    share_on_facebook_auth: function() {
        if (currentUser != null && currentUser.social_sharing.facebook || !$("#bt_toggle").is(":checked")) return;
        window.open(api.url + "/social_sharing/facebook", "_blank", "toolbar=yes, scrollbars=no, resizable=yes, top=500, left=500");
    }
});

InviteHeaderView = SimpleView.extend({
    template: JST["invite_header.html"],
    el: "#invite-header",
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "#upload_image_file change": "image_changed"
    },
    upload_image: function(upload_url) {
        var $image_form = $("#upload_image_form");
        var $invite_cover_image = $(".invite-background");
        $.ajax({
            url: upload_url,
            type: "POST",
            data: new FormData($image_form[0]),
            processData: false,
            contentType: false,
            success: function(data) {
                var url = "/image/" + data + "?" + new Date().getTime();
                $invite_cover_image.css("background-image", "url(" + url + ")");
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: "Image couldnt be uploaded"
                } ]);
            }
        });
    },
    render: function(invite_model) {
        this.model = invite_model;
        var invite_json = this.model.toJSON();
        this.$el.html(this.template(invite_json));
        if (this.options.is_admin) $("#image_select_btn").show(); else $("#image_select_btn").hide();
        this.$image_file = this.$el.find("#upload_image_file");
        this.$image_form = this.$el.find("#upload_image_form");
        var that = this;
        var invite_title_view = new InviteTitleView({
            el: ".invite-title-container",
            is_editable: this.options.is_admin
        });
        invite_title_view.render(this.model);
        this.$image_file.on("change", function() {
            $.ajax({
                url: "/image/" + that.$image_form.data("id") + "/upload_url",
                type: "GET",
                success: function(data) {
                    that.upload_image(data);
                },
                error: function(data) {
                    alert_notification([ {
                        alertType: "danger",
                        message: "Image couldnt be uploaded"
                    } ]);
                }
            });
        });
        this.$el.find("#image_select_btn").click(function() {
            that.$image_file.click();
        });
    }
});

InviteTitleView = Backbone.View.extend({
    initialize: function(options) {
        this.options = options || {
            is_editable: false
        };
    },
    render: function(model, edit_view) {
        var that = this;
        this.model = model;
        if (!edit_view) {
            var label = '<h1 class="main-h1">' + that.model.get("title") + "</h1>";
            this.$el.html(label);
            if (this.options.is_editable) {
                console.log("Editable");
                var $label = this.$el.find(".main-h1");
                $label.addClass("editable");
                $label.on("click", function() {
                    that.render(that.model, true);
                });
            }
        } else {
            var input = '<input type="text" class="edit-title-input" value="' + that.model.get("title") + '">';
            this.$el.html(input);
            this.$input = this.$el.find(".edit-title-input");
            var update = function(value) {
                that.model.set("title", value);
                that.model.updateTitle($.proxy(that.submitSuccess, that));
            };
            this.$input.on("blur", function() {
                update(that.$input.val());
            });
            this.$input.on("keyup", function(evt) {
                if (evt.keyCode != 13) {
                    return;
                }
                update(that.$input.val());
            });
        }
    },
    submitSuccess: function(result) {
        this.render(this.model, false);
    }
});

SearchView = SimpleView.extend({
    template: JST["invite_search.html"],
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .search": "search_value",
        "keypress #searchBox": "type_key",
        "click .btn-duplicate": "duplicate",
        "click .btn-edit": "edit",
        "click .btn-cancel": "cancel",
        "click .invite-background": "navigate"
    },
    render: function(invites, search) {
        this.hidePanels();
        this.model = invites;
        if (this.model != null) {
            this.$el.html(this.template({
                invites: this.model.collectionToJSON()
            }));
        } else {
            this.$el.html(this.template({
                invites: {}
            }));
            this.search();
        }
        if (search != null) {
            var $searchBox = this.$el.find("#searchBox");
            $searchBox.val(search);
            $searchBox.focus();
        }
        this.plugins();
    },
    type_key: function(e) {
        if (e.keyCode == 13) {
            var $searchBox = this.$el.find("#searchBox");
            this.search($searchBox.val());
            e.preventDefault();
            return false;
        }
    },
    search_value: function(evt) {
        var $searchBox = this.$el.find("#searchBox");
        this.search($searchBox.val());
    },
    search: function(value) {
        var that = this;
        var url = "/api/invite/search/" + currentUser.id + "?term=";
        if (value != null) url += value;
        $.ajax({
            url: url,
            type: "GET",
            cache: false,
            success: function(data) {
                var invite_list = new InviteList();
                if (data != null) {
                    data.forEach(function(invite) {
                        invite_list.add(new InviteModel(invite));
                    });
                }
                that.render(invite_list, value);
            }
        });
    },
    duplicate: function(evt) {
        evt.preventDefault();
        evt.stopPropagation();
        var $btn = $(evt.target);
        var invite_id = $btn.data("id");
        Backbone.history.navigate("new/from/" + invite_id, true);
    },
    edit: function(evt) {
        evt.preventDefault();
        evt.stopPropagation();
        var $btn = $(evt.target);
        var invite_id = $btn.data("id");
        Backbone.history.navigate("invite/" + invite_id + "/edit", true);
    },
    navigate: function(evt) {
        console.log(evt);
        var $btn = $(evt.target);
        var invite_id = $btn.data("id");
        Backbone.history.navigate("invite/" + invite_id, true);
    },
    cancel: function(evt) {
        alert("not ready yet");
    },
    plugins: function() {
        var that = this;
        that.block(".invite-background", "half");
        $(window).resize(function() {
            that.block(".invite-background", "half");
        });
    }
});

InviteView = SimpleView.extend({
    template: JST["invite.html"],
    invite_id: null,
    current_attendee: null,
    initialize: function(options) {
        this.options = options || {};
        this.inviteId = this.options.id;
    },
    hidePanels: function() {
        $("#body-container").hide();
        $("#view-container").hide();
        $("#modal_container").hide();
        $("#invite-body").show();
    },
    render: function(unique_id, invite, invite_attendee) {
        this.hidePanels();
        var self = this;
        this.invite_id = unique_id;
        if (invite_attendee != null) this.current_attendee = new Contact(invite_attendee);
        if (this.invite_id == null) console.error("Invite Id is null, check routing");
        if (invite == null) {
            var inviteModel = new InviteModel({
                unique_id: this.invite_id
            });
            inviteModel.fetch($.proxy(this.render, this));
            return;
        }
        var inviteModel = new InviteModel(invite);
        this.$el.html(this.template());
        var invite_header = new InviteHeaderView();
        var invite_details = new InviteDetailsView();
        var invite_attendees = new InviteAttendeesView();
        var invite_comments = new InviteCommentsView();
        invite_header.render(inviteModel);
        invite_details.render(inviteModel);
        invite_attendees.render({
            invite_id: this.invite_id,
            attendees: inviteModel.get("attendees"),
            current_attendee: this.current_attendee
        });
        invite_comments.render({
            invite_id: this.invite_id,
            current_attendee: this.current_attendee,
            comments: new CommentList(invite.comments)
        });
        $(".invite-description").html(invite.description);
        this.plugins();
    },
    events: {
        "keypress .invite-newComment": "addNewComment"
    },
    plugins: function() {
        var that = this;
        that.block(".invite-background", "half");
        $(window).resize(function() {
            that.block(".invite-background", "half");
        });
    }
});

LoginView = SimpleView.extend({
    template: JST["login.html"],
    render: function(options) {
        this.hidePanels();
        this.$el.html(this.template());
    }
});

ModalView = Backbone.View.extend({
    childView: null,
    template: null,
    initialize: function(options) {
        this.options = options || {};
        this.childView = this.options.childView;
        this.template = this.options.template;
        if (Backbone.pubSub._events == null || Backbone.pubSub._events["childClose"] == null) Backbone.pubSub.on("childClose", this.onChildClose, this);
    },
    render: function(data) {
        var this_el = this.$el;
        var that = this;
        if (this.options.templateId != null) {
            var template = _.template($(this.options.templateId).html(), {});
            this.$el.html(template);
        } else if (this.template != null) this.$el.html(this.template());
        if (this.childView != null) {
            this.childView.render(data);
        }
        this.$el.find(".close-modal").click(function(e) {
            that.onChildClose({
                view: that.childView
            });
        });
        this.$el.show();
        return this;
    },
    onChildClose: function(data) {
        if (this.$el != null) this.$el.hide();
        Backbone.history.navigate("", true);
    }
});

ProfileEditView = SimpleView.extend({
    template: JST["profile_edit.html"],
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .save-profile": "save"
    },
    render: function() {
        this.hidePanels();
        this.$el.html(this.template());
        this.$name = this.$el.find("#edit-profile-name");
        this.$username = this.$el.find("#edit-profile-username");
        this.$password = this.$el.find("#edit_profile_password");
        this.$password_confirm = this.$el.find("#edit_profile_password_confirm");
        this.$email = this.$el.find("#edit-profile-email");
        var that = this;
        $.ajax({
            url: "/api/profile/" + currentUser.id,
            type: "GET",
            cache: false,
            success: function(data) {
                console.log(data);
                if (data.email != null) {
                    that.$email.html(data.email);
                    that.$email.parent().addClass("floating-label-form-group-with-value");
                }
                if (data.username != null) {
                    that.$username.val(data.username);
                    that.$username.parent().addClass("floating-label-form-group-with-value");
                }
                if (data.name != null) {
                    that.$name.val(data.name + " " + data.last_name);
                    that.$name.parent().addClass("floating-label-form-group-with-value");
                }
            }
        });
    },
    save: function() {
        if (!validator.validateItems(".valid-before-submit")) return;
        if (this.$password.val() != null && this.$password.val() != this.$password_confirm.val()) {
            alert_notification([ {
                alertType: "warning",
                message: "Password and Password confirm don't match!!!"
            } ]);
        }
        var user = {
            username: this.$username.val()
        };
        user.name = this.$name.val().split(" ")[0];
        user.last_name = this.$name.val().split(" ")[1];
        if (this.$password.val() != null && this.$password.val() != "") user.password = this.$password.val();
        var that = this;
        $.ajax({
            url: "/api/profile/" + currentUser.id,
            type: "POST",
            data: JSON.stringify(user),
            cache: false,
            success: function(data) {
                Backbone.history.navigate("/search", true);
            }
        });
    }
});

SentView = Backbone.View.extend({
    template: JST["invite_sent.html"],
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .submit-register": "registerEmail"
    },
    render: function() {
        this.$el.html(this.template({
            invite_id: this.model
        }));
        this.$email = this.$el.find(".register-email");
    },
    registerEmail: function() {
        if (!validator.validateItem(this.$email)) {
            alert_notification([ {
                alertType: "warning",
                message: "You have incorrect or missing fields!"
            } ]);
            return;
        }
        var that = this;
        $.ajax({
            url: "/register/email/" + this.$email.val(),
            type: "POST",
            cache: false,
            success: function(data) {
                alert_notification([ {
                    alertType: "success",
                    message: "Account Created Successfully, please check your email"
                } ]);
                Backbone.pubSub.trigger("childClose", {
                    view: that
                });
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    }
});

UserRegisterView = SimpleView.extend({
    template: JST["register.html"],
    initialize: function(options) {
        this.options = options || {};
    },
    events: {
        "click .submit-register": "registerEmail"
    },
    render: function() {
        this.hidePanels();
        this.$el.html(this.template());
        this.$email = this.$el.find(".register-email");
    },
    registerEmail: function() {
        if (!validator.validateItem(this.$email)) {
            alert_notification([ {
                alertType: "warning",
                message: "You have incorrect or missing fields!"
            } ]);
            return;
        }
        var that = this;
        $.ajax({
            url: "/register/email/" + this.$email.val(),
            type: "POST",
            cache: false,
            success: function(data) {
                alert_notification([ {
                    alertType: "success",
                    message: "Account Created Successfully, please check your email"
                } ]);
                window.location.href = "/";
            },
            error: function(data) {
                alert_notification([ {
                    alertType: "danger",
                    message: data.responseText
                } ]);
            }
        });
    }
});

function init_app() {
    window.App = {
        Models: {},
        Collections: {},
        Views: {},
        Router: {}
    };
    Backbone.pubSub = _.extend({}, Backbone.Events);
    Backbone.pubSub.publish = Backbone.pubSub.trigger;
    Backbone.pubSub.subscribe = Backbone.pubSub.bind;
    Backbone.pubSub.unsubscribe = Backbone.pubSub.unbind;
    index_view = new IndexView({
        el: "#body-container"
    });
    login_view = new LoginView({
        el: "#view-container",
        templateId: "#login"
    });
    user_register_view = new UserRegisterView({
        el: "#view-container"
    });
    user_profile_view = new ProfileEditView({
        el: "#view-container"
    });
    search_view = new SearchView({
        el: "#view-container"
    });
    admin_view = new InviteAdminView({
        el: "#invite-body"
    });
    invite_view = new InviteView({
        el: "#invite-body"
    });
    sent_view = new SentView({
        el: "#modal_container"
    });
    sent_view_modal = new ModalView({
        el: $("#modal_container"),
        childView: sent_view
    });
    contacts_view = new ContactsView({
        el: "#contact-list"
    });
    App.Router = Backbone.Router.extend({
        routes: {
            "": "index",
            "_=_": "index",
            "new": "new",
            "new/:title": "new",
            "new/:title/from/:id": "new",
            "new/from/:id": "new_no_title",
            "sent/:id": "sent",
            search: "search",
            login: "login",
            "profile/edit": "edit_profile",
            register: "register",
            "invite/:id/edit": "view_as_organizer",
            "invite/:id": "view_as_attendee",
            "invite/:id/:invite_attendee_id": "view_as_attendee",
            contacts: "contacts",
            "contacts/new": "contacts_new"
        },
        index: function() {
            index_view.render();
        },
        login: function() {
            login_view.render();
        },
        register: function() {
            user_register_view.render();
        },
        edit_profile: function() {
            user_profile_view.render();
        },
        "new": function(title, id) {
            var newView = new InviteCreateView({
                el: "#view-container"
            });
            newView.render({
                title: title,
                id: id
            });
        },
        new_no_title: function(id) {
            this.new(null, id);
        },
        sent: function(id) {
            sent_view_modal.childView.model = id;
            sent_view_modal.render();
        },
        search: function() {
            search_view.render();
        },
        view_as_organizer: function(id) {
            var inviteX = typeof invite != "undefined" ? invite : null;
            var invite_attendeex = typeof invite_attendee != "undefined" ? invite_attendee : null;
            admin_view.render(id, inviteX, invite_attendeex);
        },
        view_as_attendee: function(id, invite_attendee_id) {
            var inviteX = typeof invite != "undefined" ? invite : null;
            var invite_attendeex = typeof invite_attendee != "undefined" ? invite_attendee : null;
            invite_view.render(id, inviteX, invite_attendeex);
        },
        contacts: function() {
            contacts_view.render({
                contactList: contactList,
                groupList: groupList
            });
        },
        contacts_new: function() {}
    });
    if (window.location.hash && window.location.hash == "#_=_") {
        window.location.hash = "";
    }
    new App.Router();
    Backbone.history.start({
        pushState: true
    });
    $("#notification-alerts").toggleClass("in");
    $("body").on("click", ".navigate", function(e) {
        var where = $(this).data("where");
        if (where != null) Backbone.history.navigate(where, true); else Backbone.history.navigate("/", true);
    });
    $("body").on("input propertychange", ".floating-label-form-group", function(e) {
        $(this).toggleClass("floating-label-form-group-with-value", !!$(e.target).val());
    }).on("focu s", ".floating-label-form-group", function() {
        $(this).addClass("floating-label-form-group-with-focus");
    }).on("blur", ".floating-label-form-group", function() {
        $(this).removeClass("floating-label-form-group-with-focus");
    });
}

$(function() {
    init_app();
});